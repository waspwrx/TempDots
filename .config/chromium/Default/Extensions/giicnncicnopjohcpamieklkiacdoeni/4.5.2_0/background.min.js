window.onload=function(){"use strict";var registered=DEFAULT_REGISTERED;var duration=DEFAULT_DURATION;var sound=DEFAULT_SOUND;var speak=DEFAULT_SPEAK;var badge=DEFAULT_BADGE;var tts_lang=DEFAULT_TTS_LANG;var remember=DEFAULT_REMEMBER;var sd=2e3;var sl=0;var actionList={};var iconList={};var hist=[];var cache={};var timeout={};var list=[];var audio=null;setTimeout(function(){try{audio=new Audio("sounds/new.ogg")}catch(error){if(DEBUG)console.log(error)}},1e3);chrome.storage.local.get(["registered","duration","sound","speak","badge","remember","device","install","settings"],function(items){if(DEBUG)console.log(items);registered=items.registered||DEFAULT_REGISTERED;duration=items.duration||DEFAULT_DURATION;sound=items.sound||DEFAULT_SOUND;speak=items.speak||DEFAULT_SPEAK;badge=items.badge||DEFAULT_BADGE;remember=items.remember||DEFAULT_REMEMBER;setIcon(registered===true);if(!items.install){chrome.storage.local.set({install:Date.now()},function(){})}else if(DEBUG){console.log("install: "+items.install)}var device=items.device||"undefined";var showSettings=typeof items.settings!=="undefined"?items.settings:DEFAULT_SETTINGS;var lsList=localStorage.getItem("list");var lsCache=localStorage.getItem("cache");if(lsList!=null&&lsCache!=null){list=JSON.parse(lsList);cache=JSON.parse(lsCache);updateBadge()}if(registered&&navigator.onLine){chrome.identity.getAuthToken({interactive:false},function(token){if(token){getInstanceID(function(iid){var data={version:VERSION,type:TYPE,device:device,duration:duration,sound:sound,speak:speak,badge:badge,remember:remember,settings:showSettings,lang:getBrowserLanguages(),time:Date.now()};if(DEBUG)console.log(data);$.post(URL_CONNECT,{token:token,iid:iid,data:JSON.stringify(data)},function(data){if(DEBUG)console.log(data)},"json")})}})}});chrome.storage.onChanged.addListener(function(changes,namespace){if(DEBUG)console.log(changes);for(var key in changes){if(changes.hasOwnProperty(key)){switch(key){case"registered":registered=changes[key].newValue||DEFAULT_REGISTERED;break;case"duration":duration=changes[key].newValue||DEFAULT_DURATION;break;case"sound":sound=changes[key].newValue||DEFAULT_SOUND;break;case"speak":speak=changes[key].newValue||DEFAULT_SPEAK;break;case"badge":badge=changes[key].newValue||DEFAULT_BADGE;break;case"remember":remember=changes[key].newValue||DEFAULT_REMEMBER;break}}}setIcon(registered===true);updateBadge()});function setIcon(on){if(on){chrome.browserAction.setIcon({path:{19:"images/icon5_19.png",38:"images/icon5_19@2x.png"}})}else{chrome.browserAction.setIcon({path:{19:"images/icon5_19_disconnect.png",38:"images/icon5_19_disconnect@2x.png"}})}}loadConfig("/config/actions.json",function(json){actionList=json});loadConfig("/config/icons.json",function(json){iconList=json});function showNotification(n){n=validate(n);var id=createNotificationId(n.code,n.package,n.tag,n.nid,n.key);if(n.package=="org.hcilab.projects.notification.newdevice"){n.title=chrome.i18n.getMessage("new_device_title");n.content=chrome.i18n.getMessage("new_device_content")+n.content}cache[id]=n;n.id=id;addToList(n);var title=n.title;var message=n.content;if(n.limited!==undefined&&n.limited==1){title="Desktop Notifications";message=n.appname}var buttons=[];if(actionList[n.package]!==undefined){buttons.push({title:chrome.i18n.getMessage(actionList[n.package]["title"])})}var opt={type:"basic",title:title,message:message,contextMessage:n.appname+" Â· "+n.dn,iconUrl:getIcon(n.package,n.tag),priority:1,buttons:buttons,eventTime:new Date(+n.time).getTime(),isClickable:true,requireInteraction:duration==999};if(TYPE==TYPE_OPERA){delete opt.buttons;opt.isClickable=true}if(duration>0){chrome.notifications.clear(n.package,function(){});chrome.notifications.create(n.package,opt,function(packageName){if(DEBUG)console.log("opened: "+packageName);clearTimeout(timeout[packageName]);if(duration<999){timeout[packageName]=setTimeout(function(){chrome.notifications.clear(packageName,function(){})},duration*1e3)}})}playSound();tts(n.package,title,message)}function validate(n){if(n.dn===undefined||n.dn===null||n.dn===""){n.dn="..."}return n}function tts(packageName,title,content){if(speak){if(packageName=="org.hcilab.projects.notification.call"){content=content.replace(/([0-9])/g,"$1 ")}var msg=title+".\n"+content;chrome.tts.speak(msg,{lang:tts_lang})}}function playSound(){if(sound&&audio!=null){chrome.notifications.getPermissionLevel(function(level){if(level=="granted"){if(Date.now()>sl+sd){sl=Date.now();audio.play()}}})}}function getIcon(packageName,tag){var icon;if(packageName=="com.android.systemui"&&tag=="low_battery"){if(DEBUG)console.log("icon: special");icon="images/appicons/org.hcilab.projects.notification.battery.low.webp"}else if(iconList[packageName]!==undefined){if(DEBUG)console.log("icon: bundled");icon="images/appicons/"+packageName+iconList[packageName]}else if(isIconCached(packageName)){if(DEBUG)console.log("icon: cached");icon=getCachedIcon(packageName)}else{icon="images/appicons/org.hcilab.projects.notification.png"}return icon}chrome.notifications.onClicked.addListener(function(packageName){if(DEBUG)console.log("click: "+packageName);clearTimeout(timeout[packageName]);chrome.notifications.clear(packageName,function(){})});if(chrome.notifications.onButtonClicked)chrome.notifications.onButtonClicked.addListener(function(packageName,index){if(DEBUG)console.log({packageName:packageName,index:index});if(packageName.charAt(0)=="_"){if(packageName=="_survey"){if(index==0){surveyActionParticipate()}else if(index==1){surveyActionDismiss()}}return}var hasAction=packageName!=null&&actionList[packageName]!==undefined;if(index==0&&hasAction){chrome.tabs.create({url:actionList[packageName]["url"]},function(tab){if(DEBUG)console.log(tab)})}});chrome.notifications.onClosed.addListener(function(packageName,byUser){if(DEBUG)console.log(packageName+" closed by "+(byUser?"user":"system"))});if(chrome.notifications.onShowSettings)chrome.notifications.onShowSettings.addListener(function(){chrome.tabs.create({url:"http://projects.hcilab.org/notification",active:true})});if(chrome.gcm)chrome.gcm.onMessage.addListener(function(message){if(DEBUG)console.log(message.data);var n;if(typeof message.data.data==="string"){n=JSON.parse(message.data.data)}else{n=message.data.data}var action=message.data.action;var mid=message.data.mid;if(n!=null){if(hist.indexOf(mid)!=-1){return}hist.unshift(mid);if(hist.length>42){hist.length=42}if(action=="create"){showNotification(n)}else if(action=="remove"){var id=createNotificationId(n.origin,n.package,n.tag,n.nid,n.key);removeFromList(id)}chrome.runtime.sendMessage({action:"event"},function(){})}});chrome.runtime.onMessage.addListener(function(message,sender,response){var action=message.action;switch(action){case"get_notifications":response(list);return true;case"dismiss_notification":removeFromList(message.id);response(list);return true;case"dismiss_all_notifications":removeAll();response();return true;case"sign_in":signIn(function(success){response(success)});return true;case"sign_out":signOut(function(){response()});return true;case"check_sign_in":getSignInStatus(function(signedIn){response(signedIn)});return true}return true});function removeAll(){if(DEBUG)console.log("removeAll()");var removeList=[];for(var i=0;i<list.length;i++){removeList.push(list[i].id)}for(i=0;i<removeList.length;i++){removeFromList(removeList[i])}}function removeFromList(id){if(DEBUG)console.log("removeFromList()");var exists=false;for(var i=0;i<list.length;i++){if(list[i].id==id){exists=true;chrome.notifications.clear(list[i].package,function(){})}}if(exists){removeFromDevice(id)}list=list.filter(function(element){return element.id!=id});updateBadge()}function removeFromDevice(id){if(DEBUG)console.log("removeFromDevice()");if(registered){chrome.identity.getAuthToken({interactive:false},function(token){if(token){getInstanceID(function(iid){var data=parseNotificationId(id);data.t=token;data.origin=data.code;data.originType=cache[id].dt;data.originTime=cache[id].time;delete data.code;data.iid=iid;$.post(URL_REMOVE,{data:JSON.stringify(data)})})}})}}function addToList(n){if(DEBUG)console.log("addToList()");list=list.filter(function(element){return element.id!=n.id});list.unshift(n);updateBadge()}function updateBadge(){if(registered&&badge){if(list.length==0){chrome.browserAction.setBadgeText({text:""})}else{chrome.browserAction.setBadgeText({text:""+list.length})}}else{chrome.browserAction.setBadgeText({text:""})}}document.test=function(p){if(p==undefined)p="com.whatsapp";showNotification({time:Date.now(),"package":p,appname:"Testapp",limited:0,dn:"Test",title:"<b>hello google.com</b>",content:"<b>test hcilab@gmail.com</b>"});chrome.runtime.sendMessage({action:"event"},function(){})};chrome.windows.onRemoved.addListener(function(){if(remember){localStorage.setItem("list",JSON.stringify(list));localStorage.setItem("cache",JSON.stringify(cache))}else{localStorage.setItem("list",JSON.stringify([]));localStorage.setItem("cache",JSON.stringify({}))}});updateBadge()};